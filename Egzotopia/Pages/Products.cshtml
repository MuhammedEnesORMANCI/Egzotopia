@page
@model Egzotopia.Pages.ProductsModel
@{
    ViewData["Title"] = "Ürünler";
}

@Html.AntiForgeryToken()

<div class="container mt-5">

    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
        <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-message">
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <h1 class="display-4 fw-bold text-success">🛍️ Tüm Ürünler</h1>
            <p class="lead text-muted">Egzotik dostlarınız için en kaliteli ürünleri keşfedin.</p>
        </div>
    </div>

    @if (Model.Products == null || Model.Products.Count == 0)
    {
        <div class="alert alert-info text-center shadow-sm">
            <h4>Henüz ürün eklenmemiş.</h4>
            <p>Yönetici panelinden ürün eklediğinizde burada görünecektir.</p>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var product in Model.Products)
            {
                <div class="col-md-6 col-lg-3 mb-4">
                    <div class="card h-100 shadow-sm border-0 hover-card">

                        <a href="/ProductDetail/@product.Id" class="text-decoration-none">
                            <div class="position-relative" style="height: 250px; overflow: hidden; background: #f8f9fa;">
                                @if (!string.IsNullOrEmpty(product.ImageUrl))
                                {
                                    <img src="@product.ImageUrl" class="w-100 h-100 product-img" style="object-fit: cover;" alt="@product.Name">
                                }
                                else
                                {
                                    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                                        <i class="bi bi-image"></i> Resim Yok
                                    </div>
                                }

                                <span class="position-absolute top-0 end-0 bg-warning text-dark px-2 py-1 m-2 rounded small fw-bold">
                                    @product.ProductType
                                </span>
                            </div>
                        </a>

                        <div class="card-body d-flex flex-column">
                            <a href="/ProductDetail/@product.Id" class="text-decoration-none text-dark">
                                <h5 class="card-title text-truncate fw-bold hover-title" title="@product.Name">@product.Name</h5>
                            </a>

                            <p class="card-text text-muted small mb-2">@product.AnimalType</p>

                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="h5 text-success mb-0 fw-bold">@product.Price.ToString("C2")</span>
                                    <small class="@(product.StockQuantity > 0 ? "text-success" : "text-danger")">
                                        @(product.StockQuantity > 0 ? $"Stok: {product.StockQuantity}" : "Tükendi")
                                    </small>
                                </div>

                                <button class="btn btn-primary w-100 rounded-pill shadow-sm"
                                        onclick="addToCart(@product.Id, '@product.Name', @product.Price)"
                                @(product.StockQuantity == 0 ? "disabled" : "")>
                                    <i class="bi bi-cart-plus"></i> Sepete Ekle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .hover-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }

    .product-img {
        transition: transform 0.5s ease;
    }

    .hover-card:hover .product-img {
        transform: scale(1.05);
    }

    .hover-title:hover {
        color: #198754 !important; /* Yeşil renk */
        text-decoration: underline !important;
    }
</style>

<script>
    function addToCart(id, name, price) {

        // Butonu geçici olarak devre dışı bırak (Çift tıklamayı önlemek için)
        // (İsteğe bağlı, basitlik için eklemedim ama iyi olur)

        var formData = new FormData();
        formData.append('productId', id);
        formData.append('name', name);
        // Fiyattaki virgül/nokta sorununu çözmek için replace yapıyoruz
        formData.append('price', price.toString().replace(',', '.'));

        // Sayfadaki Güvenlik Token'ını al
        var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        fetch('?handler=AddToCart', {
            method: 'POST',
            body: formData,
            headers: {
                "RequestVerificationToken": token
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message);
                    // Opsiyonel: Sepet sayısını güncellemek istersen buraya kod ekleyebilirsin
                } else {
                    alert("Hata: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Bir hata oluştu.");
            });
    }

    // Sağ üstte çıkan yeşil bildirim kutusu
    function showToast(message) {
        var toastEl = document.getElementById('liveToast');
        document.getElementById('toast-message').innerText = message;
        var toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
</script>